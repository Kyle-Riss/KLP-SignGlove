# MS-CSGRU 모델 아키텍처 플로우차트

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    음성 입력 (Audio Input)                                        │
│                                   센서 데이터 입력 (Sensor Input)                                 │
│                              텍스트 단위 입력: 320ms chunks                                       │
│                              센서 특징 [T, 8] (87 timesteps, 8 channels)                        │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                              ↓
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  Multi-Scale CNN Encoder                                         │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                          Multi-Head Attention (병렬 처리)                                  │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                             │  │
│  │  │  Tower 1       │  │  Tower 2       │  │  Tower 3       │                             │  │
│  │  │  Conv1D(k=3)   │  │  Conv1D(k=5)   │  │  Conv1D(k=7)   │                             │  │
│  │  │  in: 8         │  │  in: 8         │  │  in: 8         │                             │  │
│  │  │  out: 32       │  │  out: 32       │  │  out: 32       │                             │  │
│  │  │  padding: 1    │  │  padding: 2    │  │  padding: 3    │                             │  │
│  │  └────────┬───────┘  └────────┬───────┘  └────────┬───────┘                             │  │
│  │           │                   │                   │                                      │  │
│  │           │    BatchNorm1d    │    BatchNorm1d    │    BatchNorm1d                      │  │
│  │           │         ↓         │         ↓         │         ↓                           │  │
│  │           │       ReLU        │       ReLU        │       ReLU                          │  │
│  │           │         ↓         │         ↓         │         ↓                           │  │
│  │           └───────────────────┴───────────────────┘                                      │  │
│  │                               ↓                                                          │  │
│  │                      Concatenate (96 channels)                                           │  │
│  │                               ↓                                                          │  │
│  │                      BatchNorm1d(96) → ReLU                                              │  │
│  │                               ↓                                                          │  │
│  │                      MaxPool1d(kernel=2, stride=2)                                       │  │
│  │                               ↓                                                          │  │
│  │                         Dropout(p=0.3)                                                   │  │
│  │                               ↓                                                          │  │
│  │                    히든 상태 H [T/2, 96]                                                  │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                              ↓
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    Stacked GRU Layers                                            │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                            GRU Layer 1 (First Layer)                                     │  │
│  │                                                                                          │  │
│  │                    GRU Cell (input: 96, hidden: 64)                                      │  │
│  │                              ↓                                                           │  │
│  │                         Dropout(p=0.3)                                                   │  │
│  │                              ↓                                                           │  │
│  │                    출력: [T/2, 64] (43 timesteps)                                        │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              ↓                                                   │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                            GRU Layer 2 (Second Layer)                                    │  │
│  │                                                                                          │  │
│  │                    GRU Cell (input: 64, hidden: 64)                                      │  │
│  │                              ↓                                                           │  │
│  │                    출력: [T/2, 64] (43 timesteps)                                        │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                              ↓
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              패딩 인식 특징 추출 (Padding-Aware)                                │
│                                                                                                 │
│                    if x_padding is not None:                                                    │
│                        valid_lengths = (x_padding == 0).sum(dim=1) - 1                         │
│                        valid_lengths = valid_lengths.clamp(0, max_timesteps-1)                 │
│                        final_features = gru_out[batch_idx, valid_lengths]                      │
│                    else:                                                                        │
│                        final_features = gru_out[:, -1, :]                                      │
│                                                                                                 │
│                              출력: [batch, 64]                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                              ↓
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    Classifier (분류기)                                           │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                         Linear(64 → 128)                                                 │  │
│  │                              ↓                                                           │  │
│  │                            ReLU                                                          │  │
│  │                              ↓                                                           │  │
│  │                         Dropout(p=0.3)                                                   │  │
│  │                              ↓                                                           │  │
│  │                         Linear(128 → 24)                                                 │  │
│  │                              ↓                                                           │  │
│  │                    로짓 출력 [batch, 24]                                                  │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                              ↓
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    음성 출력 (Output)                                            │
│                                  영어 음성 S (24 classes)                                        │
│                                                                                                 │
│                          실시간 스트리밍 처리: 320ms chunks                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 상세 구조 설명

### 1. 입력 단계
- **입력 형태**: `(batch_size, 87, 8)`
- **87 타임스텝**: 약 2.7초 분량 (32.1 Hz 샘플링)
- **8 채널**: flex1-5 (손가락) + pitch, roll, yaw (손목)

### 2. Multi-Scale CNN Encoder
- **3개 병렬 타워**: 다양한 시간 스케일 패턴 추출
  - Tower 1 (kernel=3): 짧은 패턴 (미세 움직임)
  - Tower 2 (kernel=5): 중간 패턴 (일반 움직임)
  - Tower 3 (kernel=7): 긴 패턴 (전체 동작)
- **Concatenation**: 96 channels로 결합
- **MaxPool**: 시퀀스 길이 절반으로 축소 (87 → 43)

### 3. Stacked GRU
- **2층 구조**: 계층적 시간 표현 학습
  - GRU1: 저수준 시간 패턴
  - GRU2: 고수준 시간 패턴
- **은닉 크기**: 64

### 4. 패딩 인식 특징 추출
- **핵심 개선**: 각 샘플의 실제 마지막 타임스텝 사용
- **효과**: 패딩 오염 제거, 순수한 특징 추출

### 5. 분류기
- **2층 Dense**: 64 → 128 → 24
- **출력**: 24개 클래스 (자음 14 + 모음 10)

---

## 차원 변화 요약

```
입력:         (batch, 87, 8)
   ↓ transpose
CNN 입력:     (batch, 8, 87)
   ↓ 3 towers + concat
CNN 중간:     (batch, 96, 87)
   ↓ MaxPool(2)
CNN 출력:     (batch, 96, 43)
   ↓ transpose
GRU 입력:     (batch, 43, 96)
   ↓ GRU1
GRU1 출력:    (batch, 43, 64)
   ↓ GRU2
GRU2 출력:    (batch, 43, 64)
   ↓ 패딩 인식
특징:         (batch, 64)
   ↓ Dense
로짓:         (batch, 24)
```

---

## 핵심 특징

1. **멀티스케일 학습**: 3가지 시간 스케일 동시 처리
2. **계층적 표현**: 2층 GRU로 복잡한 패턴 학습
3. **패딩 인식**: 실제 데이터만 사용하여 정확도 향상
4. **경량 모델**: 150K 파라미터로 실시간 추론 가능
5. **높은 성능**: 99.3% 정확도 달성

